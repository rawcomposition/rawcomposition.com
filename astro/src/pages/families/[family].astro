---
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import families from '../../../families.json';
import byFamily from '../../../lifelist/by-family.json';
import taxonomy from '../../../taxonomy.json';

type Species = {
	name: string;
	code: string;
	count: number;
	date: string;
	year: string;
	family: string;
	img: number;
	w: number;
	h: number;
};

type FamilyData = {
	family: string;
	species: Species[];
};

type TaxonomyItem = {
	code: string;
	name: string;
	family: string;
};

const familyData = byFamily as FamilyData[];
const taxonomyData = taxonomy as TaxonomyItem[];
const slugToName = new Map(families.map((f) => [f.slug, f.name]));

export async function getStaticPaths() {
	return families.map((family) => ({
		params: { family: family.slug },
	}));
}

const { family: familySlug } = Astro.params;
const familyName = slugToName.get(familySlug!) ?? '';
const familySpeciesData = familyData.find((item) => item.family === familyName)?.species ?? [];
const filtered = taxonomyData.filter((item) => item.family === familyName);

const items = filtered.map(({ code, name }) => {
	const lifelistEntry = familySpeciesData.find((it) => it.name === name);
	return {
		code,
		name,
		img: lifelistEntry?.img || null,
	};
});

const withPhotos = items.filter((item) => !!item.img);
const isHummingbirds = familyName === 'Hummingbirds';
const ebirdUserId = import.meta.env.PUBLIC_EBIRD_USER_ID;
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={`${familyName} | RawComposition.com`} description={`${withPhotos.length} of ${items.length} species from the ${familyName} family`} />
	</head>
	<body>
		<Header noMargin />
		<div class="bg-neutral-800/90 p-2 mb-12">
			<div class="mx-auto max-w-[1200px] px-4 text-gray-400 text-xs sm:text-sm">
				<a href="/families" class="text-gray-200">Families</a>
				<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 512" class="icon mx-2">
					<path fill="currentColor" d="M224 256c0 1.1-.7344 3.969-2.219 5.531l-144 151.1c-3.047 3.187-8.125 3.312-11.31 .25c-3.188-3.094-3.281-8.156-.25-11.31l138.7-146.5L66.21 109.5C63.18 106.3 63.27 101.3 66.46 98.22c3.188-3.062 8.266-2.937 11.31 .25l144 151.1C223.3 252 224 254 224 256z" />
				</svg>
				{familyName}
			</div>
		</div>
		<div class="mx-auto max-w-[1200px] px-4">
			<div class="p-12 bg-white mb-4">
				<h1 class="text-4xl font-bold mb-4">{familyName}</h1>
				<p class="text-lg text-gray-500 mb-8">
					Photographed {withPhotos.length} of {items.length} species
				</p>
				<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
					{items.map(({ code, name, img }) => (
						<a
							href={img
								? `https://media.ebird.org/catalog?taxonCode=${code}&sort=rating_rank_desc&mediaType=photo&userId=${ebirdUserId}`
								: `https://ebird.org/species/${code}`
							}
							target="_blank"
							rel="noopener noreferrer"
							class="flex flex-col items-center justify-center rounded-md p-4"
						>
							{img ? (
								<img
									src={`https://cdn.download.ams.birds.cornell.edu/api/v1/asset/${img}/640`}
									loading="lazy"
									alt={name}
									class="object-cover w-full h-[160px] rounded-lg mb-2"
								/>
							) : isHummingbirds ? (
								<div class="w-full h-[160px] rounded-lg mb-2 bg-gray-200 p-4 flex items-center justify-center">
									<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="w-20 h-20 text-gray-300">
										<path fill="currentColor" d="M192.6 36.9c-9.2-7.3-22.5-5.7-29.7 3.5s-5.7 22.5 3.5 29.7l42.3 33.5c5.9 4.7 11.4 10.3 16.2 16.7l2.5 3.3-6.9 24.1c-1.5 5.2-3.4 10.2-5.8 15L132.6 63.7c-9.2-7.3-22.5-5.7-29.7 3.5s-5.7 22.5 3.5 29.7l86 68c-3.5 2.2-7.2 4.2-11 5.8L46.2 92.4c-9.2-7.3-22.5-5.7-29.7 3.5s-5.7 22.5 3.5 29.7L139.7 220c-1.5.1-3.1.2-4.6.2H104c-48.6 0-88 39.4-88 88s39.4 88 88 88h40c6.5 0 12.9-.7 19.1-2l66.9 66.9c9.4 9.4 24.6 9.4 33.9 0l16.8-16.8c23.5-23.5 30.4-58.5 17.6-88.7l25.8-12.9c32-16 56.8-42.9 69.6-75.5l8.7-22.2c12.1-31 7.5-65.9-12.3-92.7L311 51.9c-39.1-52.9-117.4-56-160.4-15zm-.1 164.5L71.3 299.9c9.8-15.7 26.8-26.1 46.1-26.4c-5.7-6.5-11.8-12.6-18.3-18.3L82.4 244c11.9-13.3 29.3-21.7 48.5-21.8c-5.2-5.6-10.6-10.9-16.2-15.9l-15.1-13.4c26-5.4 53.2 2.3 73 20.5zm156.4 113.4c3 6.9 8 12.9 14.3 17.3l-24.3 12.2-37.6-37.6 16.6-16.6 31 24.7zM168 416a24 24 0 1 1 48 0 24 24 0 1 1-48 0z" />
									</svg>
								</div>
							) : (
								<div class="w-full h-[160px] rounded-lg mb-2 bg-gray-200 p-8 flex items-center justify-center">
									<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="w-16 h-16 text-gray-300">
										<path fill="currentColor" d="M160.8 96.5c14 17 31 30.9 49.5 42.2c25.9 15.8 53.7 25.9 77.7 31.6V138.8C265.8 108.5 250 71.5 248.6 28c-.4-11.3-7.5-21.5-18.4-24.4c-7.6-2-15.8-.2-21 5.8c-13.3 15.4-32.7 44.6-48.4 87.2zM320 144v30.6l0 0v1.3l0 0 0 32.1c-60.8-5.1-185-43.8-219.3-157.2C97.4 40 87.9 32 76.6 32c-7.9 0-15.3 3.9-18.8 11C46.8 65.9 32 112.1 32 176c0 116.9 80.1 180.5 118.4 202.8L11.8 416.6C6.7 418 2.6 421.8 .9 426.8s-.8 10.6 2.3 14.8C21.7 466.2 77.3 512 160 512c3.6 0 7.2-1.2 10-3.5L245.6 448H320c88.4 0 160-71.6 160-160V128l29.9-44.9c1.3-2 2.1-4.4 2.1-6.8c0-6.8-5.5-12.3-12.3-12.3H400c-44.2 0-80 35.8-80 80zm32-64c17.7 0 32 14.3 32 32s-14.3 32-32 32s-32-14.3-32-32s14.3-32 32-32z" />
									</svg>
								</div>
							)}
							<span class="text-sm text-gray-500">{name}</span>
						</a>
					))}
				</div>
			</div>
		</div>
	</body>
</html>
