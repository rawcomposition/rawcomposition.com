---
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import ArrowLeft from '../../icons/ArrowLeft.astro';
import ArrowRight from '../../icons/ArrowRight.astro';
import overview from '../../../lifelist/overview.json';

export async function getStaticPaths() {
	return overview.years.map((year) => ({ params: { year } }));
}

const { year } = Astro.params;
const yearData = await import(`../../../lifelist/${year}.json`);
const data: { year: string; date: string; species: { name: string; code: string; count: number; img: number; w: number; h: number }[] }[] = yearData.default;

const yearIndex = overview.years.indexOf(year!);
const nextYear = overview.years[yearIndex - 1];
const prevYear = overview.years[yearIndex + 1];

const total = data.reduce((acc, item) => acc + item.species.length, 0);

const ebirdUserId = import.meta.env.PUBLIC_EBIRD_USER_ID;
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title="World Life List | RawComposition.com" description={`Bird species photographed in ${year}`} />
	</head>
	<body>
		<Header />
		<div class="mx-auto max-w-[1200px] px-4">
			<div class="bg-white p-10 mt-6 mb-5">
				<div class="flex gap-2 items-center">
					<h1 class="font-heading text-neutral-600 text-2xl sm:text-4xl mb-1">World Life List</h1>
					<span class="rounded-full bg-neutral-200 text-lg sm:text-2xl px-2.5 sm:px-4 py-px sm:py-1 text-neutral-500">
						{overview.total}
					</span>
				</div>

				<div class="flex gap-x-4 gap-y-1 text-md flex-wrap mb-2 mt-6">
					{overview.years.map((y) =>
						y === year ? (
							<span class="text-neutral-500">{y}</span>
						) : (
							<a href={`/lifelist/${y}`} class="text-[#f4793d] font-bold">{y}</a>
						)
					)}
				</div>
				<p class="mt-2">
					<span class="font-bold text-sm text-neutral-500">
						{total} lifers in {year}
					</span>
				</p>
			</div>
			<br />
			{data.map((item) => (
				<div class="mb-10">
					<div class="flex gap-3 items-center mb-10">
						<hr class="border-neutral-300 w-4" />
						<h2 class="font-bold text-sm font-heading bg-sky-600 rounded-full px-4 py-1.5 text-white w-auto inline-block">
							{item.date}
						</h2>
						<hr class="border-neutral-300 flex-grow" />
					</div>
					<div class="grid sm:grid-cols-3 gap-10 items-start">
						{item.species.map(({ name, code, count, img, w, h }) => (
							<a
								href={`https://media.ebird.org/catalog?taxonCode=${code}&sort=rating_rank_desc&mediaType=photo&userId=${ebirdUserId}`}
								target="_blank"
								rel="noopener noreferrer"
								class="block bg-white relative"
							>
								<img
									width={w}
									height={h}
									src={`https://cdn.download.ams.birds.cornell.edu/api/v1/asset/${img}/640`}
									alt={name}
									class="w-full"
									loading="lazy"
								/>
								{count > 1 && (
									<span class="absolute top-2 right-2 bg-white/40 rounded px-2 py-0.5 text-sm text-neutral-600">
										{count}
									</span>
								)}
								<div class="px-8 py-6">
									<h3 class="text-neutral-600 font-bold font-heading">{name}</h3>
								</div>
							</a>
						))}
					</div>
				</div>
			))}
			<div class="flex justify-center items-center gap-4">
				{prevYear && (
					<a href={`/lifelist/${prevYear}`} class="bg-[#f4793d] text-white py-2 px-8 flex gap-2 items-center">
						<ArrowLeft />
						{prevYear}
					</a>
				)}
				{nextYear && (
					<a href={`/lifelist/${nextYear}`} class="bg-[#f4793d] text-white py-2 px-8 flex gap-2 items-center">
						{nextYear}
						<ArrowRight />
					</a>
				)}
			</div>
		</div>
	</body>
</html>
